if("undefined"!=typeof module&&"undefined"!=typeof process)var d3=require("d3");var FireGrapher=function(){"use strict";var e=function(e,i,c){function f(e,t){for(var a in t)"object"==typeof t[a]?(e[a]=e[a]?e[a]:{},f(e[a],t[a])):e[a]=e[a]?e[a]:t[a]}a(e),r(i),s(c),f(c,n());var p=document.querySelector(i);c.styles.size={width:p.clientWidth,height:p.clientHeight};var u;switch(c.type){case"line":case"scatter":case"bar":u=new o(c,i);break;case"map":u=new l(c,i);break;case"table":u=new d(c,i);break;default:throw new Error("Invalid config type: "+c.type)}u.init();var h=new t(e,c,u),g=[{pathArray:[],path:"/",params:{}}];h.parsePath(g,0)},t=function(e,t,r){function n(e,t){u.pathsToRecords.push(e),"undefined"==typeof g[e.pathArray.join()]&&(g[e.pathArray.join()]={}),g[e.pathArray.join()][t]=c.child(e.path).on(t,function(t){var a,r,s=t.val();switch(f.type){case"map":r={path:e.path+t.name(),label:s[f.marker.label],radius:s[f.marker.magnitude],latitude:parseFloat(s[f.marker.latitude]),longitude:parseFloat(s[f.marker.longitude])};break;case"table":r=[],f.columns.forEach(function(e){r.push("undefined"!=typeof s[e.value]?s[e.value].toString():"")});break;case"bar":a="$"===f.series[0]?e.params[f.series]:s[f.series],r={path:e.path+t.name(),series:a,value:parseInt(s[f.value])};break;case"line":case"scatter":a="$"===f.series[0]?e.params[f.series]:s[f.series];var i;i="undefined"!=typeof f.xCoord.stream&&f.xCoord.stream?p.data[a]?p.data[a].streamCount:0:parseInt(s[f.xCoord.value]),r={series:a,path:e.path+t.name(),xCoord:i,yCoord:parseInt(s[f.yCoord.value])}}p.addDataPoint(r)})}function o(e,t){switch(f.type){case"bar":delete p.data[e].aggregation;break;case"line":case"scatter":delete p.data[e].values}Object.keys(g[t.join()]).forEach(function(e){var a=g[t.join()][e];c.child(t.join("/")).off(e,a)}),p.draw()}function l(e){switch(f.type){case"map":c.child(e.path).on("child_removed",function(t){p.data.forEach(function(a,r){a.path===e.path+t.name()&&p.data.splice(r,1)}),p.draw()});break;case"table":break;case"bar":case"line":case"scatter":"undefined"==typeof g[e.pathArray.join()]&&(g[e.pathArray.join()]={}),g[e.pathArray.join()].child_removed=c.child(e.path).on("child_removed",function(t){var a="$"===f.series[0]?e.params[f.series]:t.val()[f.series];p.data[a].values.forEach(function(r,s){if(r.path===e.path+t.name()){var i=p.data[a].values.splice(s,1);"bar"===f.type&&(p.data[a].sum-=i)}}),p.draw()})}}function d(){}a(e),s(t),i(r);var c=e,f=t,p=r,u=this;this.pathsToRecords=[];var h=f.path.split("/"),g={};this.parsePath=function(e,t){if(t===h.length){var a="*"===h[h.length-1]?"child_added":"value";e.forEach(function(e){n(e,a),"child_added"===a&&(l(e),d(e))})}else{var r=h[t];if("*"===r[0]){if(t!==h.length-1)throw new Error('You can only use * as the last character in your "path"');this.parsePath(e,t+1)}else if("$"===r[0])e.forEach(function(e){c.child(e.path).on("child_added",function(a){var s={path:e.path+a.name()+"/",params:{}};s.pathArray=[].concat(e.pathArray),s.pathArray.push(a.name()),s.params[r]=a.name();for(var i in e.params)e.params.hasOwnnKey(i)&&(s.params[i]=e.params);this.parsePath([s],t+1)}.bind(this)),function(t){c.child(e.path).on("child_removed",function(e){var a=[].concat(t);a.push(e.name()),o(e.name(),a)})}(e.pathArray)}.bind(this));else{var s=[];e.forEach(function(e){var t={path:e.path+r+"/",params:e.params};t.pathArray=[].concat(e.pathArray),t.pathArray.push(r),s.push(t)}),this.parsePath(s,t+1)}}}},a=function(e){var t;if("undefined"==typeof e?t='no "firebaseRef" specified':e instanceof Firebase==!1&&(t='"firebaseRef" must be an instance of Firebase'),"undefined"!=typeof t)throw new Error("FireGrapher: "+t)},r=function(e){var t;if("undefined"==typeof e)t='no "cssSelector" specified';else if("string"!=typeof e)t='"cssSelector" must be a string';else{var a=document.querySelectorAll(e);0===a.length?t="no element matches the CSS selector '"+e+"'":a.length>1&&(t="multiple elements ("+a.length+" total) match the CSS selector '"+e+"'")}if("undefined"!=typeof t)throw new Error("FireGrapher: "+t)},s=function(e){var t;"undefined"==typeof e?t='no "config" specified':"object"!=typeof e&&(t='"config" must be an object');var a=["table","line","scatter","bar","map"];switch("undefined"==typeof e.type&&(t='no graph "type" specified. Must be "table", "line", or "scatter"'),-1===a.indexOf(e.type)&&(t='Invalid graph "type" specified. Must be "table", "line", or "scatter"'),"undefined"==typeof e.path&&(t='no "path" to individual record specified'),e.type){case"map":("undefined"==typeof e.marker||"undefined"==typeof e.marker.latitude||"undefined"==typeof e.marker.longitude||"undefined"==typeof e.marker.magnitude)&&(t='incomplete "marker" definition specified. \nExpected: '+JSON.stringify(n().marker)+"\nActual: "+JSON.stringify(e.marker));break;case"table":"undefined"==typeof e.columns&&(t='no table "columns" specified'),e.columns.forEach(function(e){"undefined"==typeof e.label&&(t='missing "columns" label'),"undefined"==typeof e.value&&(t='missing "columns" value')});break;case"line":"undefined"==typeof e.xCoord&&(t='no "xCoord" specified'),"undefined"==typeof e.yCoord&&(t='no "yCoord" specified.');break;case"bar":"undefined"==typeof e.value&&(t='no "value" specified.');break;case"scatter":}if("undefined"!=typeof t)throw new Error("FireGrapher: "+t)},i=function(e){var t;if(null===e||"object"!=typeof e?t='"grapher" must be an object':"function"!=typeof e.init?t='"grapher" must have an init() method':"function"!=typeof e.draw?t='"grapher" must have a draw() method':"function"!=typeof e.addDataPoint&&(t='"grapher" must have a addDataPoint() method'),"undefined"!=typeof t)throw new Error("FireGrapher: "+t)},n=function(){var e=["#1ABC9C","#E74C3C","#9B59B6","#3498DB","#F1C40F","#D35400","#2ECC71","#E67E22","#2C3E50","#C0392B"],t=["#28E1BC","#ED7469","#B07CC6","#5FAEE3","#F4D03F","#FF6607","#54D98B","#EB9850","#3E5771","#D65448"];return{styles:{fillColor:"#DDDDDD",fillOpacity:.3,outerStrokeColor:"#000000",outerStrokeWidth:2,innerStrokeColor:"#000000",innerStrokeWidth:1,axes:{x:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}},y:{ticks:{fillColor:"#000000",fontSize:"14px"},label:{fillColor:"#000000",fontSize:"14px"}}},series:{strokeWidth:2,strokeColors:e},markers:{size:3.5,strokeWidth:2,style:"default",strokeColors:e,fillColors:t},legend:{fontSize:"16px",stroke:"#000000",strokeWidth:"2px",fill:"#AAAAAA",fillOpacity:.7}},xCoord:{label:""},yCoord:{label:""},marker:{label:"label",latitude:"latitude",longitude:"longitude",magnitude:"radius"}}},o=function(e,t){function a(e){var t=!1;"undefined"==typeof m.data[e.series]&&(t=!0,h+=1,m.data[e.series]={seriesIndex:h,values:[],aggregation:0},c.domain(Object.keys(m.data))),m.data[e.series].values.push(e.value);var a="median",r=0;switch(a){case"mean":for(var i=0;r<m.data[e.series].values.length;r++)i+=m.data[e.series].values[r];m.data[e.series].aggregation=i/m.data[e.series].values.length;break;case"median":var n=m.data[e.series].values.slice(0);n.sort(function(e,t){return e-t}),m.data[e.series].aggregation=n[Math.ceil(n.length/2)];break;case"min":for(m.data[e.series].aggregation=Number.MAX_VALUE;r<m.data[e.series].values.length;r++)m.data[e.series].values[r]<m.data[e.series].aggregation&&(m.data[e.series].aggregation=m.data[e.series].values[r]);break;case"max":for(m.data[e.series].aggregation=Number.MIN_VALUE;r<m.data[e.series].values.length;r++)m.data[e.series].values[r]>m.data[e.series].aggregation&&(m.data[e.series].aggregation=m.data[e.series].values[r]);break;case"sum":m.data[e.series].aggregation+=e.value;break;default:m.data[e.series].aggregation+=e.value}m.data[e.series].aggregation=m.data[e.series].aggregation?m.data[e.series].aggregation:0,t=t||s(null,[0,m.data[e.series].aggregation]),t?m.draw():l(h,e.series,m.data[e.series].aggregation)}function r(e){"undefined"==typeof m.data[e.series]&&(m.data[e.series]={seriesIndex:h,streamCount:0,values:[]},h+=1),m.data[e.series].streamCount+=1;var t=m.data[e.series].values;t.push(e),t.length>1&&e.xCoord<=t[t.length-2].xCoord&&t.sort(function(e,t){return t.xCoord-e.xCoord});var a=s(d3.extent(t,function(e){return e.xCoord}),d3.extent(t,function(e){return e.yCoord}));if(g.xCoord.limit&&t.length>g.xCoord.limit&&(t.shift(),c.domain(d3.extent(t,function(e){return e.xCoord})),a=!0),a)m.draw();else{var r=m.data[e.series].seriesIndex;switch(i(),g.type){case"line":n(r,t),o(r,t);break;case"scatter":o(r,t)}}}function s(e,t){var a=!1,r=!1;if(e&&e[0]<p.min&&(p.min=e[0],a=!0),e&&e[1]>p.max&&(p.max=e[1],a=!0),t&&t[0]<u.min&&(u.min=t[0],r=!0),t&&t[1]>u.max&&(u.max=t[1],r=!0),a&&c.domain([p.min,p.max]),r){var s=.1*(u.max-u.min);f.domain([u.min-s,u.max+s])}return a||r}function i(){var e=[];for(var t in m.data)"undefined"!==t&&e.push(t);if(d.selectAll("g.fg-legend").remove(),e.length>1){var a={top:5,bottom:5,left:5,right:5},r={right:5,bottom:15},s=50,i=20*e.length,n=g.styles.size.width-2*(s+a.left+a.right)-r.right,o=g.styles.size.height-2*(i+a.top+a.bottom)-r.bottom,l=d.append("g").attr("class","fg-legend");l.append("rect").attr("class","fg-legend-container").attr("x",n).attr("y",o).attr("width",s+a.left+a.right).attr("height",i+a.top+a.bottom).style("stroke",g.styles.legend.stroke).style("stroke-width",g.styles.legend.strokeWidth).style("fill",g.styles.legend.fill).style("fill-opacity",g.styles.legend.fillOpacity);var c=l.selectAll("text").data(e);c.enter().append("text").attr("class",function(e,t){return"fg-legend-series fg-series-"+t}).attr("x",n).attr("y",o).attr("dx",s).attr("dy",function(e,t){return 20*(t+1)}).style("text-anchor","end").style("stroke","none").style("fill",function(e,t){return g.styles.series.strokeColors[t]}).style("font-size",g.styles.legend.fontSize).text(function(e){return e})}}function n(e,t){var a={top:20,bottom:30,left:60,right:20},r=g.styles.size.height-2*a.bottom-a.top,s=d3.svg.area().defined(function(e){return null!==e}).x(function(e){return c(e.xCoord)}).y0(r).y1(function(e){return f(e.yCoord)});if(t){var i=d.selectAll("path.fg-area-"+e);i.empty()&&(i=d.append("path").attr("class","fg-area fg-area-"+e).attr("stroke",g.styles.series.strokeColors[e]).attr("stroke-width",g.styles.series.strokeWidth).attr("fill",g.styles.series.strokeColors[e]).attr("fill-opacity",.5)),t.length>0&&i.attr("d",s(t))}else d.selectAll("path.fg-area-"+e).remove()}function o(e,t){if(t){var a=d.selectAll("circle.fg-series-"+e).data(t);a.enter().append("circle").attr("class","fg-marker fg-series-"+e).attr("stroke",g.styles.markers.strokeColors[e]).attr("stroke-width",g.styles.markers.strokeWidth).attr("fill",g.styles.markers.fillColors[e]),a.exit().remove(),a.attr("cx",function(e){return c(e.xCoord)}).attr("cy",function(e){return f(e.yCoord)}).attr("r",g.styles.markers.size)}else d.selectAll("circle.fg-series-"+e).remove()}function l(e,t,a){"undefined"!=typeof a?d.selectAll(".fg-bar .fg-series-"+e).empty()?d.append("rect").attr("class","fg-bar fg-series-"+e):d.select(".fg-bar .fg-series-"+e).datum(a).attr("x",function(){return c(t)}).attr("width",c.rangeBand()).attr("y",function(e){return f(e)}).attr("height",function(e){return f.range()[0]-f(e)}):d.selectAll(".fg-bar .fg-series-"+e).remove()}var d,c,f,p,u,h,g=e,y=t,m=this;this.init=function(){this.data={},p={min:0,max:0},u={min:0,max:0},h=0,c="bar"===g.type?d3.scale.ordinal():d3.scale.linear().domain([p.min,p.max]),c.range([0,g.styles.size.width]),f=d3.scale.linear().domain([u.min,u.max]).range([g.styles.size.height,0])},this.draw=function(){var e={top:20,bottom:30,left:60,right:20},t=g.styles.size.height-e.bottom-e.top,a=g.styles.size.width-e.left-e.right;(!d||d3.selectAll(y+" svg").empty())&&(d=d3.select(y).append("svg").attr("class","fg-"+g.type).attr("width",g.styles.size.width).attr("height",g.styles.size.height).append("g").attr("transform","translate("+e.left+", "+e.bottom+")"),g.title&&d.append("text").attr("class","fg-title").attr("x",a/2).attr("y",0-e.top/2).attr("text-anchor","middle").style("font-size","16px").style("text-decoration","underline").text(g.title)),f.range([t-e.bottom,0]),"bar"===g.type?c.rangeRoundBands([0,a],.1,1):c.range([0,a]);var r=d3.svg.axis().orient("bottom").scale(c).ticks(Math.floor(.035*a)).tickSize(-t+e.bottom,-t+e.bottom),s=d3.svg.axis().orient("left").scale(f).ticks(Math.floor(.035*t)).tickSize(-a,-a);d.selectAll("g.fg-x-axis").empty()?(d.append("g").attr("class","fg-axis fg-x-axis").attr("transform","translate(0,"+(t-e.bottom)+")").attr("shape-rendering","crispEdges").call(r),d.append("text").attr("class","fg-axis-label fg-x-axis-label").attr("transform","translate("+a+", "+(t+e.bottom/2)+")").attr("fill",g.styles.axes.x.label.fillColor).attr("font-size",g.styles.axes.x.label.fontSize).attr("font-weight","bold").style("text-anchor","end").text(g.xCoord.label)):d.selectAll("g.fg-x-axis").call(r),d.selectAll("g.fg-y-axis").empty()?(d.append("g").attr("class","fg-axis fg-y-axis").attr("shape-rendering","crispEdges").call(s),d.append("text").attr("class","fg-axis-label fg-y-axis-label").attr("transform","rotate(-90)").attr("fill",g.styles.axes.y.label.fillColor).attr("font-size",g.styles.axes.y.label.fontSize).attr("font-weight","bold").attr("dy",-e.left+16).style("text-anchor","end").text(g.yCoord.label)):d.selectAll("g.fg-y-axis").call(s),d.selectAll(".domain").attr("stroke",g.styles.outerStrokeColor).attr("stroke-width",g.styles.outerStrokeWidth).attr("fill",g.styles.fillColor).attr("fill-opacity",g.styles.fillOpacity),d.selectAll(".fg-x-axis .tick").attr("stroke",g.styles.innerStrokeColor).attr("stroke-width","bar"===g.type?0:g.styles.innerStrokeWidth),d.selectAll(".fg-x-axis text").attr("stroke","none").attr("fill",g.styles.axes.x.ticks.fillColor).attr("font-size",g.styles.axes.x.ticks.fontSize),d.selectAll(".fg-y-axis .tick").attr("stroke",g.styles.innerStrokeColor).attr("stroke-width",g.styles.innerStrokeWidth),d.selectAll(".fg-y-axis text").attr("stroke","none").attr("fill",g.styles.axes.y.ticks.fillColor).attr("font-size",g.styles.axes.y.ticks.fontSize);for(var p in m.data)if(m.data.hasOwnProperty(p)){var u=m.data[p].seriesIndex,h=m.data[p].values;switch(g.type){case"line":i(),n(u,h),o(u,h);break;case"scatter":i(),o(u,h);break;case"bar":l(u,p,m.data[p].aggregation)}"undefined"==typeof h&&(delete m.data[p],"bar"===g.type&&(c.domain(Object.keys(m.data)),m.draw()))}},this.addDataPoint=function(e){switch(g.type){case"bar":a(e);break;case"line":case"scatter":r(e)}}},l=function(e,t){var a,r=t,s=this;this.init=function(){this.data=[];var e=new google.maps.Map(d3.select(r).node(),{zoom:8,center:new google.maps.LatLng(37.76487,-122.41948),mapTypeId:google.maps.MapTypeId.TERRAIN});a=new google.maps.OverlayView,a.onAdd=function(){function e(e){return e=new google.maps.LatLng(e.latitude,e.longitude),e=r.fromLatLngToDivPixel(e),d3.select(s).style("left",e.x-i+"px").style("top",e.y-i+"px")}var t=d3.select(a.getPanes().overlayLayer).append("div").attr("class","stations"),r=a.getProjection(),i=10;a.draw=function(){if(0!==s.data.length){var a=t.selectAll("svg").data(s.data).each(e).enter().append("svg:svg").each(e).attr("class","marker");a.append("svg:circle").attr("r",function(e){return e.radius}).attr("cx",function(e){return e.radius+i}).attr("cy",function(e){return e.radius+i}),a.append("svg:text").attr("x",i+7).attr("y",i).attr("dy",".31em").text(function(e){return e.label})}else t.selectAll("svg").remove()}},a.setMap(e)},this.draw=function(){a.draw()},this.addDataPoint=function(e){s.data.push(e),s.drawMap()}},d=function(e,t){function a(e){var t=0,a=!0;r.append("div").attr("class","fg-table-row").selectAll("div.header").data(e).enter().append("div").attr("class","fg-table-header").attr("style","font-weight: bold;").attr("width",function(e){return e.width}).text(function(e){return e.label}).on("click",function(s){for(var i=0,n=0;n<e.length;n++)e[n]===s&&(i=n);t!==i?(t=i,a=!0):a=!a,r.selectAll("div.data").sort(function(e,r){return e[t]===r[t]?0:a?e[t]>r[t]:e[t]<r[t]})})}var r,s=e,i=t,n=this;this.init=function(){this.data=[],r=d3.select(i).append("div").attr("class","fg-table").attr("style","display: inline-block;"),a(s.columns)},this.draw=function(){},this.addDataPoint=function(e){n.data.push(e),r.selectAll("div.fg-table-row").data(n.data).enter().append("div").attr("class","fg-table-row").attr("style","display: block; text-align: center; border-left: solid 3px #000; border-top: solid 3px #000;").selectAll("div.cell").data(function(e){return e}).enter().append("div").attr("class","gf-table-cell").attr("style","float: left; width: 100px; border-right: solid 3px black; padding: 5px;").attr("width",function(e,t){return s.columns[t].width}).text(function(e){return e})}};return e}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=FireGrapher);